<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDMD Settings</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <!-- Navbar injected by app.js -->

    <div class="settings">
        <main style="padding: 20px; display: flex; justify-content: center;">
            <div class="login-container glass-effect settings-config" style="margin-top: 40px; max-width: 600px;">
                <header style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <i class="fas fa-cog" style="font-size: 2rem; color: var(--accent-color);"></i>
                    <h1 class="login-title" style="margin: 0; font-size: 1.8rem;">System Configuration</h1>
                </header>

                <form onsubmit="handleSave(event)" class="settings-form" style="width: 100%;">
                    <div class="form-group">
                        <label class="login-label">Ping Interval (ms)</label>
                        <input type="number" id="pingInterval" class="input futuristic-input" placeholder="3000"
                            min="1000" max="60000" step="100" required>
                        <small style="color: var(--text-muted); font-size: 0.85rem;">Range: 1000 - 60000 ms</small>
                    </div>
                    <div class="form-group">
                        <label class="login-label">Ping Timeout (seconds)</label>
                        <input type="number" id="pingTimeout" class="input futuristic-input" placeholder="5" min="1"
                            max="30" step="1" required>
                        <small style="color: var(--text-muted); font-size: 0.85rem;">Range: 1 - 30 seconds</small>
                    </div>
                    <div class="form-group">
                        <label class="login-label">Retry Count</label>
                        <input type="number" id="retryCount" class="input futuristic-input" placeholder="3" min="1"
                            max="10" step="1" required>
                        <small style="color: var(--text-muted); font-size: 0.85rem;">Range: 1 - 10 retries</small>
                    </div>

                    <button type="submit" class="futuristic-btn" style="width: 100%;">
                        <i class="fas fa-save"></i> Save Configuration
                    </button>
                </form>
            </div>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script>
        const authHeader = { 'Authorization': `Bearer ${getToken()}`, 'Content-Type': 'application/json' };
        const CONFIG_URL = `${API_BASE_URL}/configs`;

        // Load Settings
        fetch(CONFIG_URL, { headers: authHeader })
            .then(res => {
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            })
            .then(data => {
                console.log('Loaded config:', data);
                document.getElementById('pingInterval').value = data.pingInterval || 3000;
                document.getElementById('pingTimeout').value = data.pingTimeout || 5;
                document.getElementById('retryCount').value = data.retryCount || 3;
            })
            .catch(e => {
                console.error('Error loading settings:', e);
                showToast('Using default settings', 'error');
            });

        async function handleSave(e) {
            e.preventDefault();

            const pingInterval = Number(document.getElementById('pingInterval').value);
            const pingTimeout = Number(document.getElementById('pingTimeout').value);
            const retryCount = Number(document.getElementById('retryCount').value);

            // Client-side validation
            if (pingInterval < 1000 || pingInterval > 60000) {
                showToast('Ping interval must be between 1000 and 60000 ms', 'error');
                return;
            }

            if (pingTimeout < 1 || pingTimeout > 30) {
                showToast('Ping timeout must be between 1 and 30 seconds', 'error');
                return;
            }

            if (retryCount < 1 || retryCount > 10) {
                showToast('Retry count must be between 1 and 10', 'error');
                return;
            }

            const data = { pingInterval, pingTimeout, retryCount };

            try {
                console.log('Saving config:', data);
                const res = await fetch(CONFIG_URL, {
                    method: 'PUT',
                    headers: authHeader,
                    body: JSON.stringify(data)
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.message || 'Save failed');
                }

                const result = await res.json();
                console.log('Save result:', result);
                showToast('Settings saved successfully!');
            } catch (e) {
                console.error('Error saving settings:', e);
                showToast('Error saving settings: ' + e.message, 'error');
            }
        }
    </script>
</body>

</html>