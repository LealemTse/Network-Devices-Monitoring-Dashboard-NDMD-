<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDMD Recovery</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <div class="login-wrapper">
        <div class="login-background"></div>
        <div class="login-container glass-effect">
            <h1 class="login-title">Recover Access</h1>
            <div id="status-msg" class="status-msg" style="display: none;"></div>

            <form id="questions-form" onsubmit="handleReset(event)" style="display: none;">
                <p class="login-subtitle" style="margin-bottom: 15px; text-align: center;">
                    Answer security questions for <strong>admin</strong>
                </p>

                <div class="input-group">
                    <label class="login-label" id="q1-label">Question 1</label>
                    <input type="password" id="ans1" class="input futuristic-input" placeholder="Answer 1" required>
                </div>
                <div class="input-group">
                    <label class="login-label" id="q2-label">Question 2</label>
                    <input type="password" id="ans2" class="input futuristic-input" placeholder="Answer 2" required>
                </div>
                <div class="input-group">
                    <label class="login-label">New Password</label>
                    <input type="password" id="new-pass" class="input futuristic-input" placeholder="New Secure Key"
                        required minlength="6">
                </div>

                <button type="submit" class="login-submit futuristic-btn" style="margin-top: 20px;">Reset
                    Password</button>
            </form>

            <div id="loading" style="text-align: center; color: #cbd5e1; padding: 20px;">Loading security questions...
            </div>

            <a href="login.html" class="forgot-password futuristic-link" style="margin-top: 20px;">Cancel Recovery</a>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        const username = "admin";

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch(`${API_BASE_URL}/auth/security-questions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('q1-label').innerText = data.question1;
                    document.getElementById('q2-label').innerText = data.question2;
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('questions-form').style.display = 'block';
                } else {
                    document.getElementById('loading').innerText = "Could not load questions. Is admin initialized?";
                }
            } catch (e) {
                document.getElementById('loading').innerText = "Network Error";
            }
        });

        async function handleReset(e) {
            e.preventDefault();
            const ans1 = document.getElementById('ans1').value;
            const ans2 = document.getElementById('ans2').value;
            const newPass = document.getElementById('new-pass').value;

            try {
                const res = await fetch(`${API_BASE_URL}/auth/reset-password`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, securityAnswer1: ans1, securityAnswer2: ans2, newPassword: newPass })
                });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('questions-form').style.display = 'none';
                    document.getElementById('status-msg').innerText = "Password reset successfully! Redirecting...";
                    document.getElementById('status-msg').style.display = 'block';
                    document.getElementById('status-msg').className = 'status-msg success';
                    setTimeout(() => window.location.href = '/login.html', 2000);
                } else {
                    alert(data.message || 'Reset failed');
                }
            } catch (e) { alert('Network Error'); }
        }
    </script>
</body>

</html>